<%- include("../../views/partials/user/header") %>

<section class="ftco-section shopping-page">
    <div class="container">
        <div class="row">
            <div class="col-lg-6 mb-5 ftco-animate">
                <div class="image-popup prod-img-bg" id="product-image-container">
                    <a href="/uploads/product-images/<%= product.ProductImage %>" class="img-fluid" alt="<%= product.productName %>">
                        <img src="/uploads/variant-images/<%= variant ? variant.images[0] : product.variants[0].images[0] %>" class="img-fluid" alt="<%= product.productName %>" id="product-image">
                    </a>
                    <div class="zoom-area" id="zoom-area"></div>
                    <img src="/uploads/variant-images/<%= variant ? variant.images[0] : product.variants[0].images[0] %>" class="zoomed-image" id="zoomed-image">
                </div>
            </div>
            <div class="col-lg-6 product-details pl-md-5 ftco-animate">
                <h3><%= product.productName %></h3>
                <p class="price"><span>₹<%= variant ? variant.price : product.price %></span></p>
                <p><%= product.description %></p>
                <p class="stock-info">
                    <strong>Stock Available:</strong> <%= variant && variant.stock > 0 ? variant.stock + ' items' : 'Select to view stock' %>
                </p>
                <label for="variant-select">Choose a variant:</label>
                <div class="variant-box" id="variant-select">
                    <% if (product.variants && product.variants.length > 0) { %>
                        <% for (let i = 0; i < product.variants.length; i++) { %>
                            <div class="variant-item"
                                data-variant-id="<%= product.variants[i]._id %>" 
                                data-product-id="<%= product._id %>">
                                <img src="/uploads/variant-images/<%= product.variants[i].images[0] %>" class="variant-image" alt="<%= product.variants[i].color %>">
                                <div class="variant-label"><%= product.variants[i].color %></div>
                            </div>
                        <% } %>
                    <% } else { %>
                        <div>No variants available</div>
                    <% } %>
                </div>
                
                <div class="row mt-4">
                    <div class="w-100"></div>
                    <div class="input-group col-md-6 d-flex mb-3">
                        <span class="input-group-btn mr-2">
                            <button type="button" class="quantity-left-minus btn" data-type="minus" data-field="">
                                <i class="ion-ios-remove"></i>
                            </button>
                        </span>
                        <input type="text" id="quantity" name="quantity" class="quantity form-control input-number" value="1" min="1" max="10" readonly>
                        <span class="input-group-btn ml-2">
                            <button type="button" class="quantity-right-plus btn" data-type="plus" data-field="">
                                <i class="ion-ios-add"></i>
                            </button>
                        </span>
                    </div>
                    <div class="col-md-12"></div>
                </div>
                <p>
                    <a href="/cart" class="btn btn-black py-3 px-5 mr-2">Add to Cart</a>
                </p>
            </div>
        </div>
    </div>
</section>

<!-- Toastr & jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="/user/js/zoom-image.js"></script>


<script>
    $(document).ready(function() {
        var quantity = 1;

        // Increase quantity
        $('.quantity-right-plus').click(function(e) {
            e.preventDefault();
            quantity = parseInt($('#quantity').val());
            if (quantity < 100) {
                $('#quantity').val(quantity + 1);
            }
        });

        // Decrease quantity
        $('.quantity-left-minus').click(function(e) {
            e.preventDefault();
            quantity = parseInt($('#quantity').val());
            if (quantity > 1) {
                $('#quantity').val(quantity - 1);
            }
        });

        // Handle variant selection
        $('.variant-item').on('click', function() {
            $('.variant-item').removeClass('selected');
            $(this).addClass('selected');

            var variantId = $(this).data('variantId');
            var productId = $(this).data('productId');

            console.log("Selected Variant ID: " + variantId);
            console.log("Product ID: " + productId);

            $.ajax({
                url: '/product/' + productId + '?variant=' + variantId,
                method: 'GET',
                success: function(response) {
                    $('#product-image').attr('src', '/uploads/variant-images/' + response.variant.images[0]);
                    $('#zoomed-image').attr('src', '/uploads/variant-images/' + response.variant.images[0]);
                    $('.price span').text('₹' + response.variant.price);
                    if (response.variant.stock > 0) {
                        $('.stock-info').html('<strong>Stock Available:</strong> ' + response.variant.stock + ' items');
                    } else {
                        $('.stock-info').html('<strong>Stock Available:</strong> No stock available');
                    }
                }
            });

        });

        // Handle Add to Cart button click
        $('.btn-black').click(function(e) {
            e.preventDefault();

            const selectedVariant = $('.variant-item.selected');
            const selectedVariantId = selectedVariant.data('variantId');
            const productId = '<%= product._id %>';
            const quantity = $('#quantity').val();

            console.log("Selected Variant ID: " + selectedVariantId);
            console.log("Product ID: " + productId);
            console.log("Quantity: " + quantity);

            $.ajax({
                url: '/cart/add',
                method: 'POST',
                data: {
                    variantId: selectedVariantId,
                    productId: productId,
                    quantity: quantity 
                },
                success: function(response) {
                    toastr.success('Product added to cart!');
                    window.location.href = response.redirectUrl;
                },
                error: function (error) {
                    toastr.options = {
                        positionClass: 'toast-top-right',
                        closeButton: true,
                        progressBar: true,
                        timeOut: "5000",
                        extendedTimeOut: "1000",
                        onclick: function () {
                            window.location.href = '/login';
                        }
                    };
                    toastr.error(error.responseJSON.error, "Error");
                }
            });
        });
    });
</script>



<%- include("../../views/partials/user/footer") %>

